#!/bin/bash

MOCHA=node_modules/.bin/mocha
ISTANBUL=node_modules/.bin/istanbul

# test files must end with ".test.js"
TESTS=$(shell find test/ -name "*.test.js")

coverage:
	# check if reports folder exists, if not create it
	@test -d reports || mkdir reports
	$(ISTANBUL) instrument --output rsync-cov.js rsync.js
	# move original lib code and replace it by the instrumented one
	mv rsync.js rsync.js-orig && mv rsync-cov.js rsync.js
	# tell istanbul to only generate the lcov file
	ISTANBUL_REPORTERS=lcovonly $(MOCHA) -R mocha-istanbul $(TESTS)
	# place the lcov report in the report folder,
	# remove instrumented code and put back lib at its place
	mv lcov.info reports/
	rm -rf rsync.js
	mv rsync.js-orig rsync.js
	genhtml reports/lcov.info --output-directory reports/

clean:
	rm -rf reports

test:
	$(MOCHA) -R spec $(TESTS)
